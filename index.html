<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twelve Data Time Series API Example</title>
</head>
<body onload=fetchTimeSeriesAndCreateVAP()>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume at Price (VAP) Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>

 
    <h1>Volume at Price (VAP) Chart</h1>
    <input type="text" id="symbolInput" value="AAPL">
    <button onclick="fetchTimeSeriesAndCreateVAP()">Get VAP Chart</button>

    <canvas id="vapChart" width="400" height="200"></canvas>

    <script>
// Configure Luxon as the date adapter for Chart.js
// Chart.defaults.plugins.tooltip.callbacks.label = function (context) {
//   var value = context.parsed.y;
//   if (typeof value === 'number') {
//     value = value.toFixed(2);
//   }
//   return value;
// };
        // Get the canvas element
        const canvas = document.getElementById('vapChart');
        let previousChart = null; // To keep track of the previous chart

        async function fetchTimeSeriesAndCreateVAP() {
            const symbol = document.getElementById('symbolInput').value;
            const apiKey = 'demo'; // Replace with your API key

            try {


                // Fetch historical time series data
                const response = await fetch(`https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1min&apikey=${apiKey}`);
                const data = await response.json();
                console.log(data)
                if (data.status === 'ok') {
                    const priceLevels = data.values.map(item => item.close); // Use closing prices as price levels
                    suggestedMin = Math.min(priceLevels) - 1
                    suggestedMax = Math.max(priceLevels) + 1

                if (previousChart) {
                    previousChart.destroy();
                }

                // Create a combined chart with VAP bars and Price Over Time
                const combinedChart = new Chart(canvas, {
                    data: {
                        //labels: priceLevelsFloat.map(level => `$${level.toFixed(2)}`),
                        datasets: [
                        {
                            label: 'Volume at Price',
                            data: data.values.map(item => ({
                                x: item.volume, 
                                y: item.close,
                            })),            
                            backgroundColor: 'rgba(75, 192, 192, 0.3)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            indexAxis: 'y', // Set index axis to 'y'
                            yAxisID: 'priceaxis',
                            xAxisID: 'xvap',
                            type: 'bar',
                            barThickness: 5, // Adjust the bar width as needed
                            // Configure data labels for the bar dataset
                            datalabels: {
                                display: true, // Enable data labels
                                anchor: 'end', // Position of the labels
                                align: 'top', // Alignment of the labels
                                color: 'black', // Label text color
                                font: {
                                    weight: 'bold', // Font weight
                                },
                            },

                        }, 
                        {
                            label: 'Price Over Time',
                            data: data.values.reverse().map(item => ({
                                //x: new Date(item.datetime), // Assign datetime to x-axis
                                x: item.datetime, // Assign datetime to x-axis
                                y: item.close,
                            })),            
                            borderColor: 'rgba(255, 99, 132, 1)',
                            fill: false,
                            yAxisID: 'priceaxis',
                            xAxisID: 'xprice',
                            //indexAxis: 'y',
                            type: 'line',
                        }
                        ],
                    },
                    options: {
                        scales: {
                            xvap: {
                                beginAtZero: false,
                                position: 'top',
                                grid: {
                                    display: false,
                                },                           
                            },            
                            xprice: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(20, 20, 20, 0.4)', // Customize grid line color for the y-axis
                                },
                                position: 'bottom', // Display on the bottom
                            },
                            // vapaxis: {
                            //     type: 'linear',
                            //     position: 'right',
                            //     beginAtZero: false,
                            //     min: suggestedMin,
                            //     max: suggestedMax,
                            //     grid: {
                            //         color: 'rgba(0, 255, 0, 0.7)', // Customize grid line color for the y-axis
                            //     },                            },
                            priceaxis: {
                                type: 'linear',
                                position: 'left',
                                beginAtZero: false,
                                min: suggestedMin,
                                max: suggestedMax,
                                grid: {
                                    display: false,
    
                                },
                            },
                        },
                    },
                });

                previousChart = combinedChart

                } else {
                    alert('Symbol not found or API request failed.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
    </script>


</body>
</html>
